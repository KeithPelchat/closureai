<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>{{APP_NAME}} â€“ Reset Password</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta name="theme-color" content="{{THEME_COLOR}}" />
    <link rel="manifest" href="/manifest.json" />
    <link rel="apple-touch-icon" href="{{APP_ICON_192}}" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="default"
    />

    <link rel="stylesheet" href="/styles.css" />
    <style>
      :root {
        --primary-color: {{PRIMARY_COLOR}};
        --secondary-color: {{SECONDARY_COLOR}};
      }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f3f4f6;
      }

      .auth-shell {
        width: 100%;
        max-width: 440px;
        padding: 24px;
      }

      .auth-card {
        background: #ffffff;
        border-radius: 20px;
        box-shadow: 0 18px 60px rgba(15, 23, 42, 0.15);
        padding: 24px 22px 22px;
        border: 1px solid rgba(148, 163, 184, 0.35);
      }

      .auth-brand {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 16px;
      }

      .auth-brand-logo {
        height: 32px;
        width: auto;
      }

      .auth-brand-text {
        display: flex;
        flex-direction: column;
      }

      .auth-brand-title {
        font-size: 18px;
        font-weight: 600;
        letter-spacing: 0.02em;
      }

      .auth-brand-subtitle {
        font-size: 13px;
        color: #6b7280;
      }

      .auth-heading {
        font-size: 20px;
        font-weight: 600;
        margin: 0 0 4px;
      }

      .auth-subcopy {
        font-size: 13px;
        color: #6b7280;
        margin: 0 0 18px;
      }

      .auth-field-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-bottom: 12px;
      }

      .auth-label {
        font-size: 13px;
        font-weight: 500;
        color: #374151;
      }

      .auth-input {
        border-radius: 10px;
        border: 1px solid #d1d5db;
        padding: 9px 11px;
        font-size: 14px;
        outline: none;
        width: 100%;
        box-sizing: border-box;
      }

      .auth-input:focus {
        border-color: var(--primary-color, #4f46e5);
        box-shadow: 0 0 0 1px color-mix(in srgb, var(--primary-color, #4f46e5) 15%, transparent);
      }

      .password-input-wrap {
        position: relative;
        display: flex;
        align-items: center;
      }

      .password-input-wrap .auth-input {
        padding-right: 60px;
      }

      .password-toggle {
        position: absolute;
        right: 8px;
        background: none;
        border: none;
        color: #6b7280;
        font-size: 12px;
        cursor: pointer;
        padding: 4px 8px;
      }

      .password-toggle:hover {
        color: #374151;
      }

      .password-hint {
        font-size: 11px;
        color: #9ca3af;
        margin: 2px 0 0;
      }

      .auth-actions {
        margin-top: 16px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .btn-primary {
        display: inline-flex;
        justify-content: center;
        align-items: center;
        gap: 6px;
        border-radius: 999px;
        border: none;
        padding: 9px 16px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        background: var(--primary-color, #111827);
        color: #f9fafb;
        width: 100%;
      }

      .btn-primary:disabled {
        opacity: 0.65;
        cursor: default;
      }

      .auth-status {
        margin-top: 12px;
        font-size: 12px;
        padding: 8px 12px;
        border-radius: 8px;
      }

      .auth-status--ok {
        color: #15803d;
        background: #dcfce7;
      }

      .auth-status--error {
        color: #b91c1c;
        background: #fee2e2;
      }

      .auth-status:empty {
        display: none;
      }

      .auth-link {
        color: var(--primary-color, #4f46e5);
        text-decoration: none;
      }

      .auth-link:hover {
        text-decoration: underline;
      }

      .back-link {
        margin-top: 16px;
        text-align: center;
        font-size: 13px;
      }
    </style>
  </head>
  <body>
    <div class="auth-shell">
      <section class="auth-card">
        <div class="auth-brand">
          <img
            src="{{APP_LOGO}}"
            alt="{{APP_NAME}}"
            class="auth-brand-logo"
            onerror="this.style.display='none'"
          />
          <div class="auth-brand-text">
            <span class="auth-brand-title">{{APP_NAME}}</span>
            <span class="auth-brand-subtitle">Reset password</span>
          </div>
        </div>

        <h1 class="auth-heading">Choose a new password</h1>
        <p class="auth-subcopy">
          Enter your new password below.
        </p>

        <form id="reset-form" novalidate>
          <input type="hidden" id="reset-token" value="{{RESET_TOKEN}}" />

          <div class="auth-field-group">
            <label for="password" class="auth-label">New Password</label>
            <div class="password-input-wrap">
              <input
                id="password"
                name="password"
                type="password"
                class="auth-input"
                autocomplete="new-password"
                placeholder="Enter new password"
                required
              />
              <button type="button" class="password-toggle" id="password-toggle">Show</button>
            </div>
            <p class="password-hint">
              Min 8 characters, 1 uppercase, 1 number
            </p>
          </div>

          <div class="auth-field-group">
            <label for="confirm-password" class="auth-label">Confirm Password</label>
            <div class="password-input-wrap">
              <input
                id="confirm-password"
                name="confirm-password"
                type="password"
                class="auth-input"
                autocomplete="new-password"
                placeholder="Confirm new password"
                required
              />
              <button type="button" class="password-toggle" id="confirm-toggle">Show</button>
            </div>
          </div>

          <div class="auth-actions">
            <button id="submit-btn" type="submit" class="btn-primary">
              Reset Password
            </button>
          </div>

          <div id="status" class="auth-status"></div>
        </form>

        <div class="back-link">
          <a href="/login" class="auth-link">Back to sign in</a>
        </div>
      </section>
    </div>

    <script>
      const form = document.getElementById('reset-form')
      const passwordInput = document.getElementById('password')
      const confirmInput = document.getElementById('confirm-password')
      const tokenInput = document.getElementById('reset-token')
      const submitBtn = document.getElementById('submit-btn')
      const statusEl = document.getElementById('status')
      const passwordToggle = document.getElementById('password-toggle')
      const confirmToggle = document.getElementById('confirm-toggle')

      // Password visibility toggles
      passwordToggle.addEventListener('click', () => {
        if (passwordInput.type === 'password') {
          passwordInput.type = 'text'
          passwordToggle.textContent = 'Hide'
        } else {
          passwordInput.type = 'password'
          passwordToggle.textContent = 'Show'
        }
      })

      confirmToggle.addEventListener('click', () => {
        if (confirmInput.type === 'password') {
          confirmInput.type = 'text'
          confirmToggle.textContent = 'Hide'
        } else {
          confirmInput.type = 'password'
          confirmToggle.textContent = 'Show'
        }
      })

      form.addEventListener('submit', async (e) => {
        e.preventDefault()

        const password = passwordInput.value
        const confirmPassword = confirmInput.value
        const token = tokenInput.value

        if (!password) {
          passwordInput.focus()
          statusEl.textContent = 'Please enter a new password.'
          statusEl.className = 'auth-status auth-status--error'
          return
        }

        if (password !== confirmPassword) {
          confirmInput.focus()
          statusEl.textContent = 'Passwords do not match.'
          statusEl.className = 'auth-status auth-status--error'
          return
        }

        if (!token) {
          statusEl.textContent = 'Invalid reset link. Please request a new one.'
          statusEl.className = 'auth-status auth-status--error'
          return
        }

        submitBtn.disabled = true
        statusEl.textContent = 'Resetting password...'
        statusEl.className = 'auth-status'

        try {
          const res = await fetch('/auth/reset-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token, password })
          })

          const data = await res.json()

          if (!res.ok) {
            statusEl.textContent = data.error || 'Failed to reset password. Please try again.'
            statusEl.className = 'auth-status auth-status--error'
            submitBtn.disabled = false
            return
          }

          statusEl.textContent = 'Password reset successfully! Redirecting to sign in...'
          statusEl.className = 'auth-status auth-status--ok'

          setTimeout(() => {
            window.location.href = '/login'
          }, 2000)
        } catch (err) {
          console.error('Reset error:', err)
          statusEl.textContent = 'Something went wrong. Please try again.'
          statusEl.className = 'auth-status auth-status--error'
          submitBtn.disabled = false
        }
      })
    </script>
  </body>
</html>
